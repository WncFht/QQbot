---
title: NcatBot 插件开发指南
createTime: 2023/07/15 14:30:00
permalink: /guide/plugin-dev/
---

# NcatBot 插件开发指南

## 1. 插件基础概念

NcatBot 的插件系统允许开发者扩展机器人的功能。插件位于工作目录下的 `plugins` 文件夹中，每个插件都是一个独立的文件夹。使用 `bot.run()` 启动 NcatBot 时，会自动加载所有插件。

### 1.1 插件目录结构

一个典型的插件目录结构如下：

```
- your_plugin
  - folder1
    - subfolder1-1
      - file1-1-1.yaml
      - file1-1-2.py
    - subfolder1-2
      - file1-2-1.py
      - file1-2-2.py
  - folder2
    - file2-2.py
  - main.py
  - __init__.py
  - requirements.txt
  - README.md
```

其中，`__init__.py` 用于声明插件，是必须的，其余文件都是可选的。

### 1.2 插件声明

在 `__init__.py` 中，需要声明插件，例如：

```python
from .main import MyPlugin

__all__ = ["MyPlugin"]
```

- 第一行：导入插件类
- 第三行：明确被导入的插件类

NcatBot 不对工作目录做任何保证，插件项目内部只建议使用相对导入。

## 2. 最小插件示例

下面是一个最小的插件示例，包含两个文件：

### 2.1 \_\_init\_\_.py

```python
# __init__.py
from .main import MyPlugin

__all__ = ["MyPlugin"]
```

### 2.2 main.py

```python
# main.py
import os

from ncatbot.plugin import BasePlugin, CompatibleEnrollment
from ncatbot.core.message import GroupMessage

bot = CompatibleEnrollment  # 兼容回调函数注册器


class MyPlugin(BasePlugin):
    name = "MyPlugin"  # 插件名称（必写）
    version = "0.0.1"  # 插件版本（必写）

    @bot.group_event()
    async def on_group_event(self, msg: GroupMessage):
        # 定义的回调函数
        if msg.raw_message == "测试":
            await self.api.post_group_msg(msg.group_id, text="Ncatbot 插件测试成功喵")

    async def on_load(self):
        # 插件加载时执行的操作，可缺省
        print(f"{self.name} 插件已加载")
        print(f"插件版本: {self.version}")
```

### 2.3 代码解析

#### 导入部分

```python
from ncatbot.plugin import BasePlugin, CompatibleEnrollment
from ncatbot.core.message import GroupMessage
```

- `BasePlugin`：插件基类，所有插件必须继承此类
- `CompatibleEnrollment`：兼容回调函数注册器
- `GroupMessage`：群消息类

#### 插件类定义

```python
class MyPlugin(BasePlugin):
    name = "MyPlugin"  # 插件名称
    version = "0.0.1"  # 插件版本
```

- `name`：插件名称（必写）
- `version`：插件版本（必写）

#### 回调函数

```python
@bot.group_event()
async def on_group_event(self, msg: GroupMessage):
    # 定义的回调函数
    if msg.raw_message == "测试":
        await self.api.post_group_msg(msg.group_id, text="Ncatbot 插件测试成功喵")
```

`BasePlugin.api` 是一个 `BotAPI` 对象，用于调用 API。

## 3. 插件的生命周期

### 3.1 插件加载

`BasePlugin` 提供 `on_load` 方法，重写此方法可以在插件加载时执行一些任务：

```python
class MyPlugin(BasePlugin):
    async def on_load(self):
        print(f"插件 {self.name} 加载成功")
        # 如果要执行定时任务，推荐在这里设置
```

### 3.2 插件卸载

`BasePlugin` 提供 `on_unload` 方法，重写此方法可以在插件卸载时执行一些任务：

```python
class MyPlugin(BasePlugin):
    async def on_unload(self):
        print(f"插件 {self.name} 已卸载")
        # 在这里执行清理工作
```

## 4. 事件系统

### 4.1 事件对象

事件是基本的可处理对象，一个事件由 `ncatbot.plugin.event.Event` 类表示。`Event` 类主要包含两个成员变量：

- `data: dict`：事件携带的数据
- `type: str`：事件类型

### 4.2 事件类型

事件类型命名规范为 `[插件名].[事件名]`。四大基本事件的事件名封装如下：

- `ncatbot.utils.literals.OFFICIAL_GROUP_MESSAGE_EVENT = "ncatbot.group_message_event"`
- `ncatbot.utils.literals.OFFICIAL_PRIVATE_MESSAGE_EVENT = "ncatbot.private_message_event"`
- `ncatbot.utils.literals.OFFICIAL_REQUEST_EVENT = "ncatbot.request_event"`
- `ncatbot.utils.literals.OFFICIAL_NOTICE_EVENT = "ncatbot.notice_event"`

### 4.3 订阅事件

#### 使用兼容回调函数注册器

```python
@bot.group_event()
async def on_group_event(self, msg: GroupMessage):
    # 处理群消息事件
    pass
```

#### 根据事件名称订阅事件

```python
class MyPlugin(BasePlugin):
    async def on_load(self):
        # 支持正则匹配，re:前缀
        self.register_handler("re:test\.", self.handle_test)  # 订阅 test 插件发布的所有事件
        self.register_handler("exact.match", self.handle_exact)  # 订阅 exact 插件发布的 match 事件

    async def handle_test(self, event: Event):
        print(f"正则匹配处理器: {event.data}")

    async def handle_exact(self, event: Event):
        print(f"精确匹配处理器: {event.data}")
```

### 4.4 发布事件

在 `BasePlugin` 上下文中任意位置均可发布事件：

```python
class MyPlugin(BasePlugin):
    async def some_func(self):
        event = Event("MyPlugin.event", {"message": "hello"})
        await self.event_bus.publish_async(event)  # 异步发布不等待结果
        results = self.event_bus.publish_sync(event)  # 同步等待结果
```

## 5. 数据持久化

### 5.1 内置可持久化数据

如果只需要保存一些简单的数据，可以使用内置的可持久化数据：

```python
class MyPlugin(BasePlugin):
    async def on_load(self):
        if "count" not in self.data:
            self.data["count"] = 0
        else:
            self.data["count"] += 1
        print(self.data["count"])
```

直接将数据写在 `self.data` 中即可。使用 `Ctrl+C` 正常退出 NcatBot 时，`BasePlugin.data` 的数据将会自动保存。下一次加载时，这些数据将保持为退出时的状态。

## 6. 插件依赖

### 6.1 声明插件依赖

使用 `BasePlugin.dependencies` 声明插件依赖：

```python
class MyPlugin(BasePlugin):
    name = "MyPlugin"
    version = "1.0.0"
    dependencies = {
        "OtherPlugin": ">=1.0.0",
        "Logger": ">=2.0.0"
    }
```

## 7. 复杂插件开发

### 7.1 第三方依赖

在插件目录中，添加 `requirements.txt` 文件，内容为第三方依赖的列表。对于你的用户，ncatbot-runtime 会根据你插件的 `requirements.txt` 自动安装依赖。

### 7.2 私有工作目录

`BasePlugin` 提供一个上下文管理器 `BasePlugin.work_space`，使用该上下文管理器进入插件私有目录 `data/MyPlugin/`。上下文管理器退出时，会自动修正工作目录。

```python
class MyPlugin(BasePlugin):
    name = 'MyPlugin'
    version = '1.0.0'

    def callback(self, event: Event):
        with self.work_space:
            # 在插件私有目录中执行操作
            with open("data.txt", "w") as f:
                f.write("Hello, world!")
        
        # 在原工作目录中执行操作
```

## 8. 发布插件

### 8.1 发布到官方插件仓库

NcatBot 提供了插件一键发布脚本。首先，你需要准备一个具有 repo 权限的 GitHub token。然后执行：

```bash
python -m ncatbot.scripts.publish
```

按照相关指示操作即可发布插件。如果不希望每次都输入 token，可以将 token 保存在环境变量 `GITHUB_TOKEN` 中。

### 8.2 插件使用方法

用户可以前往 [GitHub Releases](https://github.com/liyihao1110/ncatbot/releases) 下载 `main.exe`，双击 `main.exe` 并按照 CLI 的指示安装插件即可运行。

## 9. 最佳实践

### 9.1 命名规范

- 一个插件一个文件夹，"文件夹名"、"插件类名"、"name" 保持一致
- 事件类型命名为 `[插件名].[事件名]`

### 9.2 代码组织

- 使用相对导入
- 将复杂逻辑拆分到不同的模块中
- 为插件编写详细的文档和使用说明

### 9.3 错误处理

- 在回调函数中捕获异常，避免影响其他插件的运行
- 使用日志记录错误信息，方便调试

```python
async def on_group_event(self, msg: GroupMessage):
    try:
        # 处理消息
        pass
    except Exception as e:
        print(f"处理消息时出错: {e}")
```

## 10. 运行插件

要运行包含插件的 NcatBot，需要确保：

1. `ncatbot` 已经被安装到 Python 环境中
2. 工作目录下存在 `plugins/MyPlugin` 文件夹
3. 使用以下代码运行：

```python
from ncatbot.core import BotClient
from ncatbot.utils.config import config

config.set_bot_uin("123456")  # 设置 bot qq 号（必填）
config.set_ws_uri("ws://localhost:3001")  # 设置 napcat websocket server 地址
config.set_token("")  # 设置 token（napcat 服务器的 token）

bot = BotClient()

if __name__ == "__main__":
    bot.run()
```

## 总结

NcatBot 插件系统提供了强大而灵活的扩展机制，通过继承 `BasePlugin` 类并实现相应的方法，开发者可以轻松地为 NcatBot 添加新功能。本指南涵盖了插件开发的基础知识、事件系统、数据持久化、依赖管理等方面，希望能帮助你开发出功能丰富、稳定可靠的 NcatBot 插件。 